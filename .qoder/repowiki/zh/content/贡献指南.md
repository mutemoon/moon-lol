# 贡献指南

<cite>
**本文档引用的文件**
- [rustfmt.toml](file://rustfmt.toml)
- [Cargo.toml](file://Cargo.toml)
- [rust-toolchain.toml](file://rust-toolchain.toml)
- [apps/web/.prettierrc](file://apps/web/.prettierrc)
- [apps/web/tsconfig.json](file://apps/web/tsconfig.json)
- [apps/web/package.json](file://apps/web/package.json)
- [tests/attack.rs](file://tests/attack.rs)
- [tests/minion.rs](file://tests/minion.rs)
- [docs/introduction.md](file://docs/introduction.md)
- [docs/project.md](file://docs/project.md)
- [docs/skill.md](file://docs/skill.md)
- [docs/asset.md](file://docs/asset.md)
- [docs/league.md](file://docs/league.md)
- [docs/particle_system.md](file://docs/particle_system.md)
- [docs/state.md](file://docs/state.md)
- [docs/todo.md](file://docs/todo.md)
</cite>

## 目录
1. [简介](#简介)
2. [代码贡献流程](#代码贡献流程)
3. [代码风格规范](#代码风格规范)
4. [提交信息规范](#提交信息规范)
5. [测试编写与运行](#测试编写与运行)
6. [调试与性能分析](#调试与性能分析)
7. [文档更新要求](#文档更新要求)
8. [社区行为准则](#社区行为准则)

## 简介
本指南旨在为外部开发者参与moon-lol项目提供清晰的流程和规范。moon-lol是一个基于Bevy引擎的英雄联盟游戏模拟项目，包含Rust和TypeScript两种主要编程语言。本指南将详细介绍代码贡献的完整流程、代码风格要求、提交信息格式、测试方法、调试技巧以及社区协作规范。

**Section sources**
- [docs/introduction.md](file://docs/introduction.md)
- [docs/project.md](file://docs/project.md)

## 代码贡献流程
参与moon-lol项目的代码贡献需要遵循以下标准流程：

1. **Fork仓库**：首先在GitHub上fork moon-lol项目仓库到您的个人账户。

2. **克隆本地**：将fork后的仓库克隆到本地开发环境：
   ```bash
   git clone https://github.com/your-username/moon-lol.git
   cd moon-lol
   ```

3. **创建特性分支**：基于main分支创建一个新的特性分支，分支名称应具有描述性：
   ```bash
   git checkout -b feature/your-feature-name
   ```

4. **进行代码修改**：在特性分支上进行代码开发和修改。

5. **运行测试**：在提交代码前，确保所有相关测试都能通过。

6. **格式化代码**：使用项目规定的格式化工具（rustfmt和Prettier）格式化代码。

7. **提交更改**：按照提交信息规范提交代码更改。

8. **推送分支**：将特性分支推送到您的fork仓库：
   ```bash
   git push origin feature/your-feature-name
   ```

9. **创建Pull Request**：在GitHub上从您的特性分支向原仓库的main分支创建Pull Request。在PR描述中详细说明更改内容、解决的问题以及相关的测试结果。

10. **代码审查**：项目维护者将对您的PR进行审查，您可能需要根据反馈进行进一步修改。

11. **合并**：当PR通过审查并满足所有要求后，将被合并到主分支。

**Section sources**
- [docs/project.md](file://docs/project.md)

## 代码风格规范
为了保持代码库的一致性和可读性，moon-lol项目对不同语言的代码风格有明确要求。

### Rust代码风格
Rust代码必须遵循项目根目录下的`rustfmt.toml`配置文件。项目已配置Rust工具链包含`rustfmt`和`clippy`组件，确保代码格式和质量。

关键配置包括：
- `imports_granularity = "Module"`：导入语句按模块粒度分组
- `group_imports = "StdExternalCrate"`：标准库、外部crate和本地模块的导入分组

在提交代码前，请使用以下命令格式化Rust代码：
```bash
cargo fmt
```

同时建议运行`clippy`检查代码质量：
```bash
cargo clippy
```

### TypeScript代码风格
TypeScript代码遵循`apps/web`目录下的配置文件：
- `tsconfig.json`：TypeScript编译配置
- `.prettierrc`：Prettier格式化配置

Prettier配置要点：
- `htmlWhitespaceSensitivity: "ignore"`：忽略HTML空白敏感性
- `plugins`：使用`prettier-plugin-tailwindcss`和`prettier-plugin-package`插件
- `printWidth: 120`：每行最大字符数为120

在提交代码前，请使用以下命令格式化TypeScript代码：
```bash
pnpm prettier --write "apps/web/**/*.{ts,tsx,vue}"
```

**Section sources**
- [rustfmt.toml](file://rustfmt.toml)
- [rust-toolchain.toml](file://rust-toolchain.toml)
- [apps/web/.prettierrc](file://apps/web/.prettierrc)
- [apps/web/tsconfig.json](file://apps/web/tsconfig.json)
- [apps/web/package.json](file://apps/web/package.json)

## 提交信息规范
为了便于追踪代码变更历史和生成版本发布说明，所有提交信息必须遵循以下格式规范：

```
<类型>(<作用域>): <简短描述>

<详细描述>

<关联的issue>
```

### 提交类型
- `feat`：新增功能
- `fix`：修复bug
- `docs`：文档更新
- `style`：代码格式调整（不影响代码运行）
- `refactor`：代码重构
- `test`：测试相关更改
- `chore`：构建过程或辅助工具的变动

### 作用域
作用域应指明更改影响的模块或组件，例如：
- `core`：核心游戏逻辑
- `ui`：用户界面
- `loader`：资源加载器
- `config`：配置系统
- `test`：测试相关

### 示例
```
feat(core): 实现攻击系统状态机

新增攻击系统的状态机实现，包括前摇、后摇和取消机制。
支持攻速动态调整和攻击重置功能。

Closes #123
```

```
fix(ui): 修复按钮点击事件冒泡问题

修复了UI按钮组件的点击事件冒泡问题，确保事件正确处理。

Closes #124
```

**Section sources**
- [docs/todo.md](file://docs/todo.md)

## 测试编写与运行
测试是确保代码质量和功能正确性的关键环节。moon-lol项目包含单元测试和集成测试。

### 测试类型
项目中的测试主要分为：
- **单元测试**：测试单个函数或组件的正确性
- **集成测试**：测试多个组件协同工作的正确性
- **功能测试**：测试完整的游戏功能流程

### 编写测试
测试文件位于`tests/`目录下，使用Rust的`#[cfg(test)]`属性标记。测试应遵循以下原则：
- 测试用例应具有描述性的名称
- 每个测试应只测试一个明确的功能点
- 使用适当的断言验证预期结果
- 测试应尽可能覆盖边界情况和异常情况

例如，`tests/attack.rs`文件中的测试使用测试装置模式（Test Harness）来封装通用的测试设置，使测试代码更加清晰和可重用。

### 运行测试
运行所有测试：
```bash
cargo test
```

运行特定测试文件：
```bash
cargo test --test attack
```

运行特定测试函数：
```bash
cargo test test_complete_attack_cycle
```

运行测试并显示输出：
```bash
cargo test -- --nocapture
```

### 测试覆盖率
建议在开发过程中关注测试覆盖率，确保新功能有足够的测试覆盖。可以使用`cargo-llvm-cov`等工具生成测试覆盖率报告。

**Section sources**
- [tests/attack.rs](file://tests/attack.rs)
- [tests/minion.rs](file://tests/minion.rs)

## 调试与性能分析
有效的调试和性能分析是开发高质量代码的重要组成部分。

### 调试技巧
1. **日志输出**：使用`tracing`库添加详细的日志信息，帮助追踪程序执行流程。
2. **断点调试**：使用支持Rust的IDE（如VS Code）设置断点进行逐步调试。
3. **可视化调试**：利用Bevy引擎的调试功能，如`bevy_debug_stepping`特性，可视化游戏状态变化。
4. **测试驱动**：通过编写失败的测试用例来定位问题，然后修复代码使测试通过。

### 性能分析
1. **基准测试**：使用`criterion`等基准测试框架测量关键函数的性能。
2. **性能剖析**：使用`perf`（Linux）、`Instruments`（macOS）或`Visual Studio Profiler`（Windows）等工具进行性能剖析。
3. **内存分析**：使用`valgrind`或`heaptrack`等工具分析内存使用情况。
4. **渲染性能**：利用Bevy引擎的性能监控功能，分析渲染性能瓶颈。

项目性能优化建议：
- 避免在每帧中进行昂贵的计算
- 合理使用Bevy的ECS系统，优化组件查询
- 对频繁使用的资源进行缓存
- 优化资源加载策略，避免阻塞主线程

**Section sources**
- [Cargo.toml](file://Cargo.toml)
- [docs/project.md](file://docs/project.md)

## 文档更新要求
代码变更必须伴随相应的文档更新，以确保项目文档的准确性和完整性。

### 文档位置
项目文档主要位于`docs/`目录下，包括：
- `introduction.md`：项目介绍
- `project.md`：项目配置和构建信息
- `skill.md`：技能系统文档
- `asset.md`：资源系统文档
- `league.md`：英雄联盟相关技术文档
- `particle_system.md`：粒子系统文档
- `state.md`：状态系统文档
- `todo.md`：待办事项列表

### 文档更新原则
1. **同步更新**：代码变更后立即更新相关文档
2. **准确性**：文档内容必须与实际代码实现一致
3. **完整性**：新增功能必须有相应的文档说明
4. **可读性**：使用清晰、简洁的语言，必要时配以图表说明

### 文档格式
文档使用Markdown格式编写，遵循以下规范：
- 使用适当的标题层级
- 代码示例使用代码块标记
- 复杂流程使用Mermaid图表说明
- 关键概念使用加粗或斜体强调

**Section sources**
- [docs/introduction.md](file://docs/introduction.md)
- [docs/project.md](file://docs/project.md)
- [docs/skill.md](file://docs/skill.md)
- [docs/asset.md](file://docs/asset.md)
- [docs/league.md](file://docs/league.md)
- [docs/particle_system.md](file://docs/particle_system.md)
- [docs/state.md](file://docs/state.md)
- [docs/todo.md](file://docs/todo.md)

## 社区行为准则
为了营造健康、积极的协作环境，所有参与者必须遵守以下行为准则：

1. **尊重他人**：以尊重和礼貌的态度对待其他贡献者，避免使用攻击性或贬低性的语言。

2. **建设性反馈**：在代码审查和讨论中提供具体、有建设性的反馈，关注代码本身而非个人。

3. **包容性**：欢迎不同背景和经验水平的贡献者，耐心指导新成员。

4. **专业精神**：保持专业态度，即使在意见分歧时也应理性讨论。

5. **及时响应**：对PR审查、问题报告等及时响应，避免长时间无响应。

6. **知识共享**：乐于分享知识和经验，帮助团队共同成长。

7. **遵守规范**：严格遵守项目的技术规范和流程要求。

8. **积极协作**：主动参与项目讨论，提出改进建议，共同推动项目发展。

违反行为准则的参与者将收到警告，严重或重复违规者可能会被限制参与项目。

**Section sources**
- [docs/todo.md](file://docs/todo.md)