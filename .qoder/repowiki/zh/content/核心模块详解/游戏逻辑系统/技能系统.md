# 技能系统

<cite>
**本文档引用的文件**
- [fiora_passive.rs](file://src/abilities/fiora_passive.rs)
- [fiora_e.rs](file://src/abilities/fiora_e.rs)
- [fiora_r.rs](file://src/abilities/fiora_r.rs)
- [fiora.rs](file://src/entities/champions/fiora.rs)
- [skill.rs](file://src/core/skill.rs)
- [action.rs](file://src/core/action.rs)
- [animation.rs](file://src/core/animation.rs)
- [cooldown.rs](file://src/core/cooldown.rs)
- [damage.rs](file://src/core/damage.rs)
- [particle.rs](file://src/core/particle.rs)
- [state.rs](file://src/core/base/state.rs)
- [buff.rs](file://src/core/base/buff.rs)
- [ui/skill.rs](file://src/core/ui/skill.rs)
</cite>

## 目录
1. [技能系统架构概述](#技能系统架构概述)
2. [核心组件分析](#核心组件分析)
3. [技能类型实现详解](#技能类型实现详解)
4. [技能与动作系统交互机制](#技能与动作系统交互机制)
5. [技能配置与自定义开发](#技能配置与自定义开发)
6. [常见问题与解决方案](#常见问题与解决方案)
7. [总结](#总结)

## 技能系统架构概述

本技能系统基于Bevy ECS架构设计，采用模块化插件系统，实现了技能冷却管理、施放逻辑、状态维护等核心功能。系统通过统一的接口注册机制，支持不同类型的技能（主动技能、被动技能、大招等）注册并响应玩家或AI指令。

技能系统的核心架构包括：
- **技能注册与管理**：通过`Skill`组件和`Skills`关系组件管理角色的技能集合
- **冷却系统**：基于`CoolDown`组件和`PluginCooldown`插件实现技能冷却计时
- **行为树执行**：使用`bevy_behave`库实现技能效果的行为树驱动
- **事件驱动机制**：通过Bevy的事件系统实现技能施放、升级等操作的触发与响应

系统通过`PluginSkill`插件初始化技能相关组件和系统，并注册技能施放、升级等事件的监听器。

```mermaid
graph TB
subgraph "技能系统"
Skill[技能组件]
CoolDown[冷却组件]
BehaviorTree[行为树]
EventSystem[事件系统]
end
subgraph "交互系统"
ActionSystem[动作系统]
AnimationSystem[动画系统]
ParticleSystem[粒子系统]
DamageSystem[伤害系统]
end
Skill --> |触发| ActionSystem
Skill --> |播放| AnimationSystem
Skill --> |生成| ParticleSystem
Skill --> |造成| DamageSystem
CoolDown --> |控制| Skill
BehaviorTree --> |驱动| Skill
EventSystem --> |通知| Skill
```

**图示来源**
- [skill.rs](file://src/core/skill.rs)
- [action.rs](file://src/core/action.rs)
- [animation.rs](file://src/core/animation.rs)
- [particle.rs](file://src/core/particle.rs)
- [damage.rs](file://src/core/damage.rs)

## 核心组件分析

### 技能组件结构

技能系统的核心组件包括`Skill`、`CoolDown`、`Skills`等，它们共同构成了技能的基础数据结构。

```mermaid
classDiagram
class Skill {
+key_spell_object : HashKey<SpellObject>
+key_skill_effect : HashKey<SkillEffect>
+level : usize
}
class CoolDown {
+timer : Timer
+duration : f32
}
class Skills {
+0..* : Skill
}
class SkillEffect {
+tree : Tree<Behave>
}
class SkillPoints {
+points : u32
}
Skill --> CoolDown : "包含"
Skills --> Skill : "聚合"
Skill --> SkillEffect : "引用"
SkillPoints --> Skill : "影响"
```

**图示来源**
- [skill.rs](file://src/core/skill.rs#L50-L72)
- [fiora.rs](file://src/entities/champions/fiora.rs#L137-L155)

### 技能事件系统

技能系统通过事件驱动机制实现技能的施放和升级操作，主要包括`CommandSkillStart`和`CommandSkillLevelUp`两个核心事件。

```mermaid
sequenceDiagram
participant Player as "玩家"
participant UI as "UI系统"
participant SkillSystem as "技能系统"
participant ActionSystem as "动作系统"
participant AnimationSystem as "动画系统"
Player->>UI : 点击技能按钮
UI->>SkillSystem : 触发CommandSkillStart
SkillSystem->>SkillSystem : 检查冷却状态
alt 冷却完成
SkillSystem->>SkillSystem : 检查技能等级
alt 技能已学习
SkillSystem->>SkillSystem : 检查资源消耗
alt 资源充足
SkillSystem->>ActionSystem : 触发技能行为树
ActionSystem->>AnimationSystem : 播放技能动画
SkillSystem->>SkillSystem : 开始技能冷却
SkillSystem-->>Player : 技能施放成功
else 资源不足
SkillSystem-->>Player : 资源不足提示
end
else 技能未学习
SkillSystem-->>Player : 技能未学习提示
end
else 技能冷却中
SkillSystem-->>Player : 冷却中提示
end
```

**图示来源**
- [skill.rs](file://src/core/skill.rs#L94-L177)
- [action.rs](file://src/core/action.rs#L43-L96)
- [animation.rs](file://src/core/animation.rs#L50-L56)

## 技能类型实现详解

### 菲奥娜被动技能实现

菲奥娜的被动技能通过`PluginFioraPassive`插件实现，主要功能包括破绽生成、破绽移除和破绽命中处理。

```mermaid
flowchart TD
Start([被动技能初始化]) --> UpdateAddVital["更新添加破绽"]
UpdateAddVital --> CheckDistance{"距离检查"}
CheckDistance --> |在范围内| CheckTeam{"敌我检查"}
CheckTeam --> |敌方单位| CheckRBuff{"是否被R技能标记"}
CheckRBuff --> |未标记| GenerateVital["生成破绽"]
GenerateVital --> SetDirection["设置破绽方向"]
SetDirection --> SpawnWarning["生成警告粒子"]
SpawnWarning --> End1([破绽生成完成])
Start --> UpdateRemoveVital["更新移除破绽"]
UpdateRemoveVital --> CheckDistance2{"距离检查"}
CheckDistance2 --> |超出范围| RemoveVital["移除破绽"]
RemoveVital --> End2([破绽移除完成])
UpdateRemoveVital --> CheckActive{"是否激活"}
CheckActive --> |未激活| TickActiveTimer["激活计时器"]
TickActiveTimer --> CheckActiveFinish{"激活完成"}
CheckActiveFinish --> |是| SpawnActiveParticle["生成激活粒子"]
SpawnActiveParticle --> End3([激活完成])
CheckActive --> |已激活| CheckTimeout{"是否接近超时"}
CheckTimeout --> |是| SpawnTimeoutParticle["生成超时警告粒子"]
SpawnTimeoutParticle --> SetTimeoutFlag["设置超时标记"]
SetTimeoutFlag --> TickRemoveTimer["移除计时器"]
TickRemoveTimer --> CheckRemoveFinish{"移除完成"}
CheckRemoveFinish --> |是| RemoveVital2["移除破绽"]
RemoveVital2 --> End4([破绽移除完成])
```

**图示来源**
- [fiora_passive.rs](file://src/abilities/fiora_passive.rs#L24-L231)
- [fiora.rs](file://src/entities/champions/fiora.rs#L137-L145)

### 菲奥娜E技能实现

菲奥娜的E技能通过`PluginFioraE`插件实现，主要功能是攻击重置和攻击速度加成。

```mermaid
sequenceDiagram
participant AttackSystem as "攻击系统"
participant ESkill as "E技能系统"
participant BuffSystem as "Buff系统"
AttackSystem->>ESkill : 触发EventAttackEnd
ESkill->>ESkill : 查找E技能Buff
ESkill->>BuffSystem : 获取BuffFioraE组件
BuffSystem-->>ESkill : 返回Buff组件
ESkill->>ESkill : 减少剩余攻击次数
alt 剩余次数>0
ESkill-->>AttackSystem : 继续保持Buff
else 剩余次数<=0
ESkill->>BuffSystem : 移除Buff实体
BuffSystem-->>ESkill : Buff移除完成
end
ESkill-->>AttackSystem : 处理完成
```

**图示来源**
- [fiora_e.rs](file://src/abilities/fiora_e.rs#L8-L42)
- [fiora.rs](file://src/entities/champions/fiora.rs#L86-L95)

### 菲奥娜R技能实现

菲奥娜的R技能通过`PluginFioraR`插件实现，主要功能包括破绽标记、破绽命中处理和治疗光环触发。

```mermaid
flowchart TD
Start([R技能施放]) --> SpawnBuff["生成R技能Buff"]
SpawnBuff --> SetDirections["设置四个方向破绽"]
SetDirections --> StartActiveTimer["开始激活计时器"]
StartActiveTimer --> WaitActive["等待激活完成"]
WaitActive --> CheckActiveFinish{"激活完成"}
CheckActiveFinish --> |是| SpawnMarkParticles["生成标记粒子"]
SpawnMarkParticles --> End1([R技能激活完成])
Start --> FixedUpdate["固定更新"]
FixedUpdate --> CheckTimeout{"是否接近超时"}
CheckTimeout --> |是| SpawnTimeoutParticles["生成超时粒子"]
SpawnTimeoutParticles --> SetTimeoutFlag["设置超时标记"]
SetTimeoutFlag --> StartRemoveTimer["开始移除计时器"]
StartRemoveTimer --> WaitRemove["等待移除完成"]
WaitRemove --> CheckRemoveFinish{"移除完成"}
CheckRemoveFinish --> |是| CleanupParticles["清理所有粒子"]
CleanupParticles --> DespawnBuff["移除Buff实体"]
DespawnBuff --> End2([R技能结束])
Start --> OnDamageCreate["伤害事件"]
OnDamageCreate --> CheckDirection{"方向检查"}
CheckDirection --> |命中破绽| RemoveDirection["移除对应方向"]
RemoveDirection --> SpawnHitParticle["生成命中粒子"]
SpawnHitParticle --> RemoveMarkParticles["移除标记粒子"]
RemoveMarkParticles --> CheckAllHit{"是否全部命中"}
CheckAllHit --> |是| TriggerHeal["触发治疗光环"]
TriggerHeal --> DespawnBuff2["移除Buff实体"]
DespawnBuff2 --> End3([R技能完成])
```

**图示来源**
- [fiora_r.rs](file://src/abilities/fiora_r.rs#L19-L200)
- [fiora.rs](file://src/entities/champions/fiora.rs#L113-L118)

## 技能与动作系统交互机制

### 命令分发机制

技能系统通过命令系统与动作系统、动画系统等进行交互，实现技能效果的执行。

```mermaid
sequenceDiagram
participant SkillSystem as "技能系统"
participant ActionSystem as "动作系统"
participant AnimationSystem as "动画系统"
participant ParticleSystem as "粒子系统"
participant DamageSystem as "伤害系统"
SkillSystem->>ActionSystem : 触发CommandAction
ActionSystem->>ActionSystem : 解析动作类型
alt 动作类型为技能
ActionSystem->>SkillSystem : 触发CommandSkillStart
SkillSystem->>SkillSystem : 执行技能行为树
SkillSystem->>AnimationSystem : 触发CommandAnimationPlay
AnimationSystem->>AnimationSystem : 播放技能动画
SkillSystem->>ParticleSystem : 触发CommandParticleSpawn
ParticleSystem->>ParticleSystem : 生成技能粒子
SkillSystem->>DamageSystem : 触发CommandDamageCreate
DamageSystem->>DamageSystem : 计算并应用伤害
SkillSystem->>SkillSystem : 开始技能冷却
end
SkillSystem-->>Player : 技能执行完成
```

**图示来源**
- [action.rs](file://src/core/action.rs#L43-L96)
- [animation.rs](file://src/core/animation.rs#L50-L56)
- [particle.rs](file://src/core/particle.rs#L116-L126)
- [damage.rs](file://src/core/damage.rs#L38-L47)

### 状态变更机制

技能施放会触发角色状态的变更，系统通过状态组件和事件系统实现状态管理。

```mermaid
stateDiagram-v2
[*] --> Idle
Idle --> Running : "移动指令"
Running --> Idle : "移动结束"
Idle --> Attacking : "攻击指令"
Attacking --> Idle : "攻击结束"
Idle --> Casting : "技能施放"
Casting --> Idle : "技能完成"
Casting --> Interrupted : "技能中断"
Interrupted --> Idle : "恢复空闲"
classDef default fill : #ECEFF1,stroke : #37474F,stroke-width : 2px;
classDef active fill : #FFCC80,stroke : #EF6C00,stroke-width : 3px;
class Casting,Interrupted active
```

**图示来源**
- [state.rs](file://src/core/base/state.rs#L16-L22)
- [animation.rs](file://src/core/animation.rs#L285-L306)
- [action.rs](file://src/core/action.rs#L61-L89)

## 技能配置与自定义开发

### 技能配置方法

技能配置主要通过在角色插件中注册技能效果和初始化技能组件来实现。

```mermaid
flowchart TD
Start([角色插件初始化]) --> LoadAssets["加载技能效果资源"]
LoadAssets --> DefineQSkill["定义Q技能"]
DefineQSkill --> CreateQBehavior["创建Q技能行为树"]
CreateQBehavior --> AddQAnimation["添加动画播放"]
AddQAnimation --> AddQParticle["添加粒子生成"]
AddQParticle --> AddQDash["添加突进动作"]
AddQDash --> AddQDamage["添加伤害"]
AddQDamage --> StoreQEffect["存储Q技能效果"]
LoadAssets --> DefineWSkill["定义W技能"]
DefineWSkill --> CreateWBehavior["创建W技能行为树"]
CreateWBehavior --> AddWParticle["添加预警粒子"]
AddWParticle --> AddWAnimation["添加动画播放"]
AddWAnimation --> AddWDamage["添加伤害"]
AddWDamage --> StoreWEffect["存储W技能效果"]
LoadAssets --> DefineESkill["定义E技能"]
DefineESkill --> CreateEBehavior["创建E技能行为树"]
DefineEBehavior --> AddEBuff["添加攻击速度Buff"]
AddEBuff --> AddEAttackReset["添加攻击重置"]
AddEAttackReset --> StoreEEffect["存储E技能效果"]
LoadAssets --> DefineRSkill["定义R技能"]
DefineRSkill --> CreateRBehavior["创建R技能行为树"]
CreateRBehavior --> AddRParticle["添加指示器粒子"]
AddRParticle --> AddRCommand["添加Buff生成命令"]
AddRCommand --> StoreREffect["存储R技能效果"]
Start --> AddSkills["添加技能组件"]
AddSkills --> CreatePassive["创建被动技能"]
CreatePassive --> SetPassiveKeys["设置技能键值"]
SetPassiveKeys --> AddPassiveCooldown["添加冷却组件"]
AddPassiveCooldown --> RegisterPassive["注册被动技能"]
AddSkills --> CreateActiveSkills["创建主动技能"]
CreateActiveSkills --> LoopSpells["遍历技能列表"]
LoopSpells --> CreateSkill["创建技能组件"]
CreateSkill --> SetSkillKeys["设置技能键值"]
SetSkillKeys --> AddSkillCooldown["添加冷却组件"]
AddSkillCooldown --> RegisterSkill["注册主动技能"]
LoopSpells --> CheckEnd{"遍历结束"}
CheckEnd --> |否| LoopSpells
CheckEnd --> |是| End([技能配置完成])
```

**图示来源**
- [fiora.rs](file://src/entities/champions/fiora.rs#L33-L157)
- [hwei.rs](file://src/entities/champions/hwei.rs#L26-L119)

### 自定义技能开发指南

开发自定义技能需要遵循以下步骤：

1. **创建技能插件**：实现`Plugin` trait，注册必要的系统和事件监听器
2. **定义技能组件**：创建技能特有的组件，用于存储技能状态
3. **实现技能逻辑**：编写技能的核心逻辑函数
4. **注册技能效果**：在角色插件中注册技能的行为树效果
5. **初始化技能组件**：在角色初始化时添加技能组件

```mermaid
flowchart LR
A[创建技能插件] --> B[定义技能组件]
B --> C[实现技能逻辑]
C --> D[注册技能效果]
D --> E[初始化技能组件]
E --> F[测试与调试]
subgraph "技能插件"
A1[实现build方法]
A2[注册系统]
A3[注册事件监听器]
end
subgraph "技能组件"
B1[状态组件]
B2[配置组件]
B3[数据组件]
end
subgraph "技能逻辑"
C1[主逻辑函数]
C2[辅助函数]
C3[事件处理函数]
end
subgraph "技能效果"
D1[行为树定义]
D2[动画播放]
D3[粒子生成]
D4[伤害计算]
end
subgraph "组件初始化"
E1[添加组件]
E2[设置初始值]
E3[建立关系]
end
A --> A1
A --> A2
A --> A3
B --> B1
B --> B2
B --> B3
C --> C1
C --> C2
C --> C3
D --> D1
D --> D2
D --> D3
D --> D4
E --> E1
E --> E2
E --> E3
```

**图示来源**
- [fiora_passive.rs](file://src/abilities/fiora_passive.rs#L21-L31)
- [fiora_e.rs](file://src/abilities/fiora_e.rs#L6-L11)
- [fiora_r.rs](file://src/abilities/fiora_r.rs#L16-L23)
- [fiora.rs](file://src/entities/champions/fiora.rs#L21-L25)

## 常见问题与解决方案

### 技能冷却异常

技能冷却异常通常由以下原因引起：

```mermaid
flowchart TD
Problem[技能冷却异常] --> Cause1["冷却计时器未正确更新"]
Cause1 --> Solution1["检查PluginCooldown是否正确注册"]
Solution1 --> Check1["确认add_systems(FixedUpdate, fixed_update_cooldown)"]
Cause1 --> Solution2["检查CoolDown组件是否正确添加"]
Solution2 --> Check2["确认技能实体包含CoolDown组件"]
Problem --> Cause2["冷却时间重置错误"]
Cause2 --> Solution3["检查on_skill_cast中冷却设置"]
Solution3 --> Check3["确认cooldown.timer = Timer::from_seconds(...)"]
Problem --> Cause3["多线程竞争"]
Cause3 --> Solution4["确保冷却更新在主线程"]
Solution4 --> Check4["检查系统执行顺序"]
Problem --> Cause4["事件重复触发"]
Cause4 --> Solution5["添加防重机制"]
Solution5 --> Check5["在触发前检查冷却状态"]
```

**图示来源**
- [cooldown.rs](file://src/core/cooldown.rs#L8-L18)
- [skill.rs](file://src/core/skill.rs#L171-L176)
- [fiora_passive.rs](file://src/abilities/fiora_passive.rs#L27-L28)

### 技能中断问题

技能中断问题的解决方案：

```mermaid
flowchart TD
Problem[技能中断问题] --> Cause1["状态管理不当"]
Cause1 --> Solution1["完善状态转换逻辑"]
Solution1 --> Check1["确保State组件正确更新"]
Check1 --> Ref1["参考state.rs中的状态转换"]
Problem --> Cause2["动画未正确停止"]
Cause2 --> Solution2["完善动画停止逻辑"]
Solution2 --> Check2["检查Animation组件的stop方法"]
Check2 --> Ref2["参考animation.rs中的stop实现"]
Problem --> Cause3["Buff未正确清理"]
Cause3 --> Solution3["完善Buff清理逻辑"]
Solution3 --> Check3["检查BuffOf和Buffs组件关系"]
Check3 --> Ref3["参考buff.rs中的组件定义"]
Problem --> Cause4["粒子效果残留"]
Cause4 --> Solution4["完善粒子清理逻辑"]
Solution4 --> Check4["检查CommandParticleDespawn触发"]
Check4 --> Ref4["参考particle.rs中的清理逻辑"]
Problem --> Cause5["命令队列阻塞"]
Cause5 --> Solution5["优化命令处理"]
Solution5 --> Check5["检查CommandAction处理逻辑"]
Check5 --> Ref5["参考action.rs中的命令分发"]
```

**图示来源**
- [state.rs](file://src/core/base/state.rs)
- [animation.rs](file://src/core/animation.rs#L220-L232)
- [buff.rs](file://src/core/base/buff.rs)
- [particle.rs](file://src/core/particle.rs#L297-L315)
- [action.rs](file://src/core/action.rs#L58-L96)

## 总结

本文档详细解析了技能系统的架构与实现，涵盖了技能冷却管理、施放逻辑、状态维护等核心功能。通过分析菲奥娜的被动、E技能和R技能的具体实现，展示了不同技能类型如何通过统一接口注册并响应玩家或AI指令。

技能系统与动作系统、动画系统之间的交互机制通过命令分发与状态变更实现，确保了技能效果的正确执行。文档还提供了技能配置方法和自定义技能开发指南，并分析了技能施放过程中的常见问题如冷却异常、技能中断等的解决方案。

系统设计遵循模块化原则，各组件职责清晰，便于扩展和维护。通过Bevy ECS架构和事件驱动机制，实现了高效、灵活的技能系统。

**文档来源**
- [fiora_passive.rs](file://src/abilities/fiora_passive.rs)
- [fiora_e.rs](file://src/abilities/fiora_e.rs)
- [fiora_r.rs](file://src/abilities/fiora_r.rs)
- [fiora.rs](file://src/entities/champions/fiora.rs)
- [skill.rs](file://src/core/skill.rs)
- [action.rs](file://src/core/action.rs)
- [animation.rs](file://src/core/animation.rs)
- [cooldown.rs](file://src/core/cooldown.rs)
- [damage.rs](file://src/core/damage.rs)
- [particle.rs](file://src/core/particle.rs)
- [state.rs](file://src/core/base/state.rs)
- [buff.rs](file://src/core/base/buff.rs)
- [ui/skill.rs](file://src/core/ui/skill.rs)